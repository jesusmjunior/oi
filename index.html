<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Análise de Subregistro Civil - COGEX-MA</title>
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="https://www.ma.gov.br/favicon.ico" type="image/x-icon">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- CSS Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js" charset="utf-8"></script>
    
    <!-- D3.js (para algumas visualizações específicas) -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        :root {
            --primary: #1a237e;
            --primary-light: #534bae;
            --primary-dark: #000051;
            --secondary: #d32f2f;
            --secondary-light: #ff6659;
            --secondary-dark: #9a0007;
            --text-on-primary: #ffffff;
            --text-on-secondary: #ffffff;
            --background: #f5f5f5;
            --card-bg: #ffffff;
            --border: #e0e0e0;
            --success: #388e3c;
            --warning: #f57c00;
            --danger: #d32f2f;
            --info: #0288d1;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background);
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Header styles */
        .dashboard-header {
            background-color: var(--primary);
            color: var(--text-on-primary);
            padding: 1rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .dashboard-title {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .dashboard-subtitle {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        /* Card styles */
        .card {
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            height: 100%;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1rem;
            font-weight: 500;
        }

        /* Metric card styles */
        .metric-card {
            text-align: center;
            padding: 1rem;
        }

        .metric-title {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .metric-change {
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
        }

        .metric-change.positive {
            color: var(--success);
        }

        .metric-change.negative {
            color: var(--danger);
        }

        .metric-icon {
            display: inline-block;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(26, 35, 126, 0.1);
            color: var(--primary);
            line-height: 50px;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        /* Chart container styles */
        .chart-container {
            min-height: 400px;
            width: 100%;
            position: relative;
        }

        /* Loading spinner */
        .loading-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tab navigation */
        .nav-tabs .nav-link {
            color: #495057;
            padding: 0.75rem 1rem;
            border: none;
            border-bottom: 3px solid transparent;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background-color: transparent;
        }

        .nav-tabs .nav-link:hover:not(.active) {
            border-bottom-color: #dee2e6;
        }

        /* Alert styles */
        .alert-custom {
            border-left: 4px solid;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
        }

        .alert-icon {
            margin-right: 1rem;
            font-size: 1.5rem;
        }

        .alert-danger {
            border-left-color: var(--danger);
            background-color: rgba(211, 47, 47, 0.05);
        }

        .alert-danger .alert-icon {
            color: var(--danger);
        }

        .alert-info {
            border-left-color: var(--info);
            background-color: rgba(2, 136, 209, 0.05);
        }

        .alert-info .alert-icon {
            color: var(--info);
        }

        /* Table styles */
        .custom-table th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }

        .custom-table .badge {
            font-weight: 500;
            font-size: 0.75rem;
        }

        /* Footer styles */
        .dashboard-footer {
            margin-top: 2rem;
            padding: 1rem 0;
            text-align: center;
            font-size: 0.875rem;
            color: #666;
            border-top: 1px solid var(--border);
        }

        /* Animation for tab content */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .dashboard-title {
                font-size: 1.25rem;
            }
            
            .dashboard-subtitle {
                font-size: 0.75rem;
            }
            
            .metric-value {
                font-size: 1.5rem;
            }
            
            .chart-container {
                min-height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="dashboard-header mb-4">
        <div class="container d-flex justify-content-between align-items-center">
            <div>
                <h1 class="dashboard-title">Dashboard de Análise de Subregistro Civil</h1>
                <p class="dashboard-subtitle">Corregedoria do Foro Extrajudicial do Tribunal de Justiça do Maranhão (COGEX-MA)</p>
            </div>
            <div class="d-flex align-items-center">
                <div class="text-white me-3">
                    <i class="fas fa-calendar-alt me-1"></i>
                    <span>Maio de 2025</span>
                </div>
                <button class="btn btn-light btn-sm" id="btnExportData">
                    <i class="fas fa-download me-1"></i>
                    Exportar
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Filtros e Controles -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-filter me-2"></i>Filtros
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="selectAno" class="form-label">Ano</label>
                            <select class="form-select" id="selectAno">
                                <option value="carregando">Carregando...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="selectMunicipio" class="form-label">Município</label>
                            <select class="form-select" id="selectMunicipio">
                                <option value="todos">Todos os Municípios</option>
                                <option value="carregando">Carregando...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Regiões (para comparação)</label>
                            <div id="checkboxesRegioes">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <span class="ms-2">Carregando regiões...</span>
                            </div>
                        </div>
                        <hr>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="checkUnidadesInterligadas" checked>
                                <label class="form-check-label" for="checkUnidadesInterligadas">
                                    Mostrar informações sobre unidades interligadas
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="checkInfoCogex" checked>
                                <label class="form-check-label" for="checkInfoCogex">
                                    Mostrar informações sobre COGEX
                                </label>
                            </div>
                        </div>
                        <button class="btn btn-secondary w-100" id="btnResetFilters">
                            <i class="fas fa-sync-alt me-1"></i>
                            Resetar Filtros
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-9">
                <!-- KPI Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="metric-card">
                                <div class="metric-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <h3 class="metric-title">Taxa de Subregistro (MA)</h3>
                                <div class="metric-value" id="metricTaxaSubregistro">--</div>
                                <div class="metric-change negative" id="metricTaxaSubregistroChange">
                                    <i class="fas fa-arrow-up me-1"></i>
                                    <span>--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="metric-card">
                                <div class="metric-icon" style="background-color: rgba(56, 142, 60, 0.1); color: var(--success);">
                                    <i class="fas fa-baby"></i>
                                </div>
                                <h3 class="metric-title">Nascidos Vivos (MA)</h3>
                                <div class="metric-value" id="metricNascidosVivos">--</div>
                                <div class="metric-change positive" id="metricNascidosVivosChange">
                                    <i class="fas fa-arrow-up me-1"></i>
                                    <span>--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="metric-card">
                                <div class="metric-icon" style="background-color: rgba(2, 136, 209, 0.1); color: var(--info);">
                                    <i class="fas fa-file-signature"></i>
                                </div>
                                <h3 class="metric-title">Registros Civis (MA)</h3>
                                <div class="metric-value" id="metricRegistrosCivis">--</div>
                                <div class="metric-change positive" id="metricRegistrosCivisChange">
                                    <i class="fas fa-arrow-up me-1"></i>
                                    <span>--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="metric-card">
                                <div class="metric-icon" style="background-color: rgba(245, 124, 0, 0.1); color: var(--warning);">
                                    <i class="fas fa-hospital"></i>
                                </div>
                                <h3 class="metric-title">Unidades Interligadas</h3>
                                <div class="metric-value">125</div>
                                <div class="metric-change positive">
                                    <i class="fas fa-arrow-up me-1"></i>
                                    <span>+5 vs 2022</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="panorama-tab" data-bs-toggle="tab" data-bs-target="#panorama" type="button" role="tab" aria-controls="panorama" aria-selected="true">
                            <i class="fas fa-globe-americas me-1"></i>
                            Panorama Geral
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="municipio-tab" data-bs-toggle="tab" data-bs-target="#municipio" type="button" role="tab" aria-controls="municipio" aria-selected="false">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            Análise por Município
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="historico-tab" data-bs-toggle="tab" data-bs-target="#historico" type="button" role="tab" aria-controls="historico" aria-selected="false">
                            <i class="fas fa-chart-line me-1"></i>
                            Séries Históricas
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Tab 1: Panorama Geral -->
                    <div class="tab-pane fade show active" id="panorama" role="tabpanel" aria-labelledby="panorama-tab">
                        <!-- Gráfico de Taxa por Região -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-chart-bar me-2"></i>Comparativo de Taxa de Subregistro por Região</span>
                                <button class="btn btn-sm btn-outline-secondary download-chart" data-chart="chartTaxaRegiao">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" id="chartTaxaRegiao">
                                    <div class="loading-container">
                                        <div class="spinner"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Gráfico de Taxa por Município -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-map me-2"></i>Distribuição do Subregistro nos Municípios do Maranhão</span>
                                <button class="btn btn-sm btn-outline-secondary download-chart" data-chart="chartTaxaMunicipio">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" id="chartTaxaMunicipio">
                                    <div class="loading-container">
                                        <div class="spinner"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Alerta sobre risco de subregistro -->
                        <div class="alert-custom alert-danger">
                            <div class="alert-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div>
                                <h5>Alerta de Risco de Subregistro</h5>
                                <p class="mb-0">A partir de janeiro/2025, o ON-RCPN adotou entendimento pelo qual apenas delegatários, interinos ou prepostos de serventias extrajudiciais podem emitir certidões, afetando o acesso nas maternidades e criando risco de aumento do subregistro.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab 2: Análise por Município -->
                    <div class="tab-pane fade" id="municipio" role="tabpanel" aria-labelledby="municipio-tab">
                        <!-- Conteúdo condicional baseado na seleção de município -->
                        <div id="municipioDetalhado" style="display: none;">
                            <!-- KPIs do município -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="metric-card">
                                            <h3 class="metric-title">Taxa de Subregistro</h3>
                                            <div class="metric-value" id="metricMunicipioTaxa">--</div>
                                            <div class="metric-change" id="metricMunicipioTaxaChange">
                                                <i class="fas fa-arrow-down me-1"></i>
                                                <span>--</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="metric-card">
                                            <h3 class="metric-title">Nascidos Vivos</h3>
                                            <div class="metric-value" id="metricMunicipioNascidos">--</div>
                                            <div class="metric-change positive" id="metricMunicipioNascidosChange">
                                                <i class="fas fa-arrow-up me-1"></i>
                                                <span>--</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="metric-card">
                                            <h3 class="metric-title">Registros Civis</h3>
                                            <div class="metric-value" id="metricMunicipioRegistros">--</div>
                                            <div class="metric-change positive" id="metricMunicipioRegistrosChange">
                                                <i class="fas fa-arrow-up me-1"></i>
                                                <span>--</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Gráfico de evolução do município -->
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span id="chartEvolucaoMunicipioTitle"><i class="fas fa-chart-line me-2"></i>Evolução da Taxa de Subregistro</span>
                                    <button class="btn btn-sm btn-outline-secondary download-chart" data-chart="chartEvolucaoMunicipio">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container" id="chartEvolucaoMunicipio">
                                        <div class="loading-container">
                                            <div class="spinner"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Gráfico de comparação com média estadual -->
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-chart-area me-2"></i>Comparação com a Média Estadual</span>
                                    <button class="btn btn-sm btn-outline-secondary download-chart" data-chart="chartComparativoEstadual">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container" id="chartComparativoEstadual">
                                        <div class="loading-container">
                                            <div class="spinner"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabela de todos os municípios -->
                        <div id="todosMunicipios">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-table me-2"></i>Dados de Todos os Municípios</span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-secondary me-2" id="btnExportTable">
                                            <i class="fas fa-download me-1"></i>CSV
                                        </button>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                Ordenar
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                <li><button class="dropdown-item sort-table" data-sort="taxa" data-order="desc">Taxa (maior → menor)</button></li>
                                                <li><button class="dropdown-item sort-table" data-sort="taxa" data-order="asc">Taxa (menor → maior)</button></li>
                                                <li><button class="dropdown-item sort-table" data-sort="municipio" data-order="asc">Município (A → Z)</button></li>
                                                <li><button class="dropdown-item sort-table" data-sort="nascidos" data-order="desc">Nascidos Vivos (maior → menor)</button></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive" style="max-height: 400px;">
                                        <table class="table table-striped table-hover custom-table" id="tableMunicipios">
                                            <thead>
                                                <tr>
                                                    <th>Município</th>
                                                    <th>Nascidos Vivos</th>
                                                    <th>Registros Civis</th>
                                                    <th>Taxa de Subregistro</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td colspan="5" class="text-center">Carregando dados...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Gráfico Top 5 municípios -->
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-chart-bar me-2"></i>Top 5 Municípios com Maior Taxa de Subregistro</span>
                                    <button class="btn btn-sm btn-outline-secondary download-chart" data-chart="chartTop5Municipios">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container" id="chartTop5Municipios">
                                        <div class="loading-container">
                                            <div class="spinner"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab 3: Séries Históricas -->
                    <div class="tab-pane fade" id="historico" role="tabpanel" aria-labelledby="historico-tab">
                        <!-- Evolução histórica da taxa de subregistro -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-chart-line me-2"></i>Evolução Histórica da Taxa de Subregistro</span>
                                <button class="btn btn-sm btn-outline-secondary download-chart" data-chart="chartEvolucaoHistorica">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" id="chartEvolucaoHistorica">
                                    <div class="loading-container">
                                        <div class="spinner"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Conteúdo condicional sobre unidades interligadas -->
                        <div id="unidadesInterligadasContent">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <i class="fas fa-hospital me-2"></i>Unidades Interligadas em Hospitais
                                </div>
                                <div class="card-body">
                                    <div class="row mb-4">
                                        <div class="col-md-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title">Total de Unidades</h5>
                                                    <h2 class="mb-0">125</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title">Unidades Operacionais</h5>
                                                    <h2 class="mb-0">119</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title">Problemas de Acesso</h5>
                                                    <h2 class="mb-0">119</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card bg-light">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title">Risco de Subregistro</h5>
                                                    <h2 class="mb-0 text-danger">Alto</h2>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="alert-custom alert-info">
                                        <div class="alert-icon">
                                            <i class="fas fa-info-circle"></i>
                                        </div>
                                        <div>
                                            <h5>Impacto das Unidades Interligadas</h5>
                                            <p class="mb-0">As unidades interligadas são essenciais para o registro civil de nascimento nas maternidades, contribuindo significativamente para a redução do subregistro. A política recente do ON-RCPN pode comprometer esse avanço.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Conteúdo condicional sobre COGEX -->
                        <div id="infoCoGEXContent">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <i class="fas fa-building me-2"></i>Informações sobre a COGEX
                                </div>
                                <div class="card-body">
                                    <p>A Corregedoria Geral do Foro Extrajudicial (COGEX) foi criada pela Lei Complementar n.º 271, de 25 de junho de 2024, com competência para fiscalizar os serviços extrajudiciais do Estado do Maranhão.</p>
                                    
                                    <h5 class="mt-4">Principais desafios relacionados ao registro civil:</h5>
                                    <ul>
                                        <li>Ressarcimentos não integrais pelo FERC aos registradores civis</li>
                                        <li>A partir de janeiro/2025, o ON-RCPN adotou entendimento pelo qual apenas delegatários, interinos ou prepostos podem emitir certidões em papel nas unidades interligadas</li>
                                        <li>Risco de aumento do subregistro devido à preferência da população por certidões em papel</li>
                                    </ul>
                                    
                                    <h5 class="mt-4">Principais Ações Recomendadas</h5>
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Problema</th>
                                                    <th>Ação Recomendada</th>
                                                    <th>Prazo</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>Ressarcimentos não integrais pelo FERC</td>
                                                    <td>Regularizar fluxo de ressarcimentos e garantir pagamento integral aos registradores</td>
                                                    <td>30 dias</td>
                                                </tr>
                                                <tr>
                                                    <td>Limitação na emissão de certidões em unidades interligadas</td>
                                                    <td>Implementar campanha de conscientização sobre validade da certidão digital</td>
                                                    <td>60 dias</td>
                                                </tr>
                                                <tr>
                                                    <td>Falta de capacitação em LGPD e PLD/FT</td>
                                                    <td>Estabelecer programa institucional de capacitação</td>
                                                    <td>90 dias</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="dashboard-footer">
        <div class="container">
            <p>© 2025 Corregedoria Geral do Foro Extrajudicial do TJMA. Dados atualizados em maio de 2025.</p>
        </div>
    </footer>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- App JavaScript -->
    <script>
        // Variáveis globais
        let dadosMunicipios = [];
        let dadosRegioes = [];
        let metadados = {};
        let anoSelecionado = null;
        let municipioSelecionado = 'todos';
        let regioesSelecionadas = ['Brasil', 'Maranhão'];

        // Funções para formatar números
        function formatarNumero(numero) {
            return numero.toLocaleString('pt-BR');
        }

        function formatarPercentual(valor) {
            return valor.toFixed(1) + '%';
        }

        // Função para carregar dados de arquivos JSON
        async function carregarDados() {
            try {
                // Mostrar todos os loaders
                document.querySelectorAll('.loading-container').forEach(loader => {
                    loader.style.display = 'flex';
                });
                
                // Carregar arquivos JSON
                const [respostaMetadados, respostaMunicipios, respostaRegioes] = await Promise.all([
                    fetch('data/metadados.json'),
                    fetch('data/municipios.json'),
                    fetch('data/regioes.json')
                ]);
                
                // Processar respostas
                metadados = await respostaMetadados.json();
                dadosMunicipios = await respostaMunicipios.json();
                dadosRegioes = await respostaRegioes.json();
                
                console.log('Dados carregados com sucesso!');
                console.log('Metadados:', metadados);
                
                // Inicializar interface após carregamento dos dados
                inicializarInterface();
                
            } catch (erro) {
                console.error('Erro ao carregar dados:', erro);
                
                // Mostrar mensagem de erro
                alert('Erro ao carregar dados. Consulte o console para mais detalhes.');
                
                // Usar dados de demonstração em caso de erro
                usarDadosDemonstracao();
            } finally {
                // Ocultar todos os loaders
                document.querySelectorAll('.loading-container').forEach(loader => {
                    loader.style.display = 'none';
                });
            }
        }

        // Função para usar dados de demonstração em caso de erro
        function usarDadosDemonstracao() {
            console.log('Usando dados de demonstração...');
            
            // Dados demonstrativos para municípios
            dadosMunicipios = [
                { "Município": "São Luís", "Ano": 2023, "Nascidos_Vivos": 16852, "Registros_Civil": 16431, "Taxa_Subregistro": 2.5 },
                { "Município": "Imperatriz", "Ano": 2023, "Nascidos_Vivos": 3687, "Registros_Civil": 3540, "Taxa_Subregistro": 4.0 },
                { "Município": "São José de Ribamar", "Ano": 2023, "Nascidos_Vivos": 2654, "Registros_Civil": 2458, "Taxa_Subregistro": 7.4 },
                { "Município": "Timon", "Ano": 2023, "Nascidos_Vivos": 2557, "Registros_Civil": 2442, "Taxa_Subregistro": 4.5 },
                { "Município": "Caxias", "Ano": 2023, "Nascidos_Vivos": 2463, "Registros_Civil": 2280, "Taxa_Subregistro": 7.4 },
                { "Município": "Codó", "Ano": 2023, "Nascidos_Vivos": 1840, "Registros_Civil": 1710, "Taxa_Subregistro": 7.1 },
                { "Município": "Bacabeira", "Ano": 2023, "Nascidos_Vivos": 241, "Registros_Civil": 218, "Taxa_Subregistro": 9.5 },
                { "Município": "Raposa", "Ano": 2023, "Nascidos_Vivos": 462, "Registros_Civil": 423, "Taxa_Subregistro": 8.4 },
                { "Município": "Paço do Lumiar", "Ano": 2023, "Nascidos_Vivos": 2231, "Registros_Civil": 2113, "Taxa_Subregistro": 5.3 },
                { "Município": "Balsas", "Ano": 2023, "Nascidos_Vivos": 1447, "Registros_Civil": 1374, "Taxa_Subregistro": 5.0 },
                { "Município": "Santa Inês", "Ano": 2023, "Nascidos_Vivos": 1354, "Registros_Civil": 1259, "Taxa_Subregistro": 7.0 },
                { "Município": "Açailândia", "Ano": 2023, "Nascidos_Vivos": 1694, "Registros_Civil": 1593, "Taxa_Subregistro": 6.0 },
                { "Município": "Buriticupu", "Ano": 2023, "Nascidos_Vivos": 1092, "Registros_Civil": 984, "Taxa_Subregistro": 9.9 },
                { "Município": "Barra do Corda", "Ano": 2023, "Nascidos_Vivos": 1320, "Registros_Civil": 1208, "Taxa_Subregistro": 8.5 }
            ];
            
            // Anos anteriores (simulados)
            const anosAnteriores = [2018, 2019, 2020, 2021, 2022];
            const municipiosUnicos = [...new Set(dadosMunicipios.map(m => m.Município))];
            
            for (const municipio of municipiosUnicos) {
                for (const ano of anosAnteriores) {
                    const municipioAtual = dadosMunicipios.find(m => m.Município === municipio && m.Ano === 2023);
                    
                    // Taxa de subregistro diminuindo ao longo dos anos
                    const fatorHistorico = Math.max(0.8, (2024 - ano) / 10);
                    const taxaBase = municipioAtual.Taxa_Subregistro;
                    const taxa = taxaBase * fatorHistorico * (1 + (Math.random() * 0.2 - 0.1));
                    
                    // População aumentando levemente
                    const nascidosBase = municipioAtual.Nascidos_Vivos;
                    const popFator = (ano - 2018) / (2023 - 2018);
                    const nascidos = Math.round(nascidosBase * (0.9 + 0.1 * popFator) * (1 + (Math.random() * 0.1 - 0.05)));
                    
                    // Registros com base na taxa de subregistro
                    const registros = Math.round(nascidos * (1 - taxa/100));
                    
                    dadosMunicipios.push({
                        "Município": municipio,
                        "Ano": ano,
                        "Nascidos_Vivos": nascidos,
                        "Registros_Civil": registros,
                        "Taxa_Subregistro": Math.max(0, Math.min(15, taxa))
                    });
                }
            }
            
            // Dados demonstrativos para regiões
            dadosRegioes = [
                { "Região": "Brasil", "Ano": 2023, "Nascidos_Vivos": 2805901, "Registros_Civil": 2749783, "Taxa_Subregistro": 2.0 },
                { "Região": "Nordeste", "Ano": 2023, "Nascidos_Vivos": 868204, "Registros_Civil": 834676, "Taxa_Subregistro": 3.8 },
                { "Região": "Norte", "Ano": 2023, "Nascidos_Vivos": 322542, "Registros_Civil": 308528, "Taxa_Subregistro": 4.3 },
                { "Região": "Sudeste", "Ano": 2023, "Nascidos_Vivos": 1096275, "Registros_Civil": 1078831, "Taxa_Subregistro": 1.6 },
                { "Região": "Sul", "Ano": 2023, "Nascidos_Vivos": 339958, "Registros_Civil": 336559, "Taxa_Subregistro": 1.0 },
                { "Região": "Centro-Oeste", "Ano": 2023, "Nascidos_Vivos": 178922, "Registros_Civil": 176190, "Taxa_Subregistro": 1.5 },
                { "Região": "Maranhão", "Ano": 2023, "Nascidos_Vivos": 107537, "Registros_Civil": 102160, "Taxa_Subregistro": 5.0 }
            ];
            
            // Anos anteriores (simulados)
            for (const região of dadosRegioes) {
                for (const ano of anosAnteriores) {
                    // Taxa de subregistro diminuindo ao longo dos anos
                    const fatorHistorico = Math.max(0.8, (2024 - ano) / 10);
                    const taxaBase = região.Taxa_Subregistro;
                    const taxa = taxaBase * fatorHistorico * (1 + (Math.random() * 0.2 - 0.1));
                    
                    // População aumentando levemente
                    const nascidosBase = região.Nascidos_Vivos;
                    const popFator = (ano - 2018) / (2023 - 2018);
                    const nascidos = Math.round(nascidosBase * (0.9 + 0.1 * popFator) * (1 + (Math.random() * 0.1 - 0.05)));
                    
                    // Registros com base na taxa de subregistro
                    const registros = Math.round(nascidos * (1 - taxa/100));
                    
                    dadosRegioes.push({
                        "Região": região.Região,
                        "Ano": ano,
                        "Nascidos_Vivos": nascidos,
                        "Registros_Civil": registros,
                        "Taxa_Subregistro": Math.max(0, Math.min(15, taxa))
                    });
                }
            }
            
            // Criar metadados com base nos dados de demonstração
            metadados = {
                "anos_disponiveis": [2018, 2019, 2020, 2021, 2022, 2023],
                "municipios_disponiveis": municipiosUnicos,
                "regioes_disponiveis": [...new Set(dadosRegioes.map(r => r.Região))],
                "data_atualizacao": new Date().toISOString()
            };
            
            // Inicializar interface com dados de demonstração
            inicializarInterface();
        }

        // Função para inicializar a interface após o carregamento dos dados
        function inicializarInterface() {
            // Configurar seletores de ano
            const selectAno = document.getElementById('selectAno');
            selectAno.innerHTML = ''; // Limpar opções existentes
            
            if (metadados.anos_disponiveis && metadados.anos_disponiveis.length > 0) {
                // Ordenar anos em ordem decrescente
                const anosOrdenados = [...metadados.anos_disponiveis].sort((a, b) => b - a);
                
                // Adicionar opções para cada ano
                anosOrdenados.forEach(ano => {
                    const option = document.createElement('option');
                    option.value = ano;
                    option.textContent = ano;
                    selectAno.appendChild(option);
                });
                
                // Selecionar o ano mais recente por padrão
                anoSelecionado = anosOrdenados[0];
                selectAno.value = anoSelecionado;
            } else {
                // Caso não haja anos disponíveis
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Nenhum ano disponível';
                selectAno.appendChild(option);
            }
            
            // Configurar seletor de município
            const selectMunicipio = document.getElementById('selectMunicipio');
            selectMunicipio.innerHTML = '<option value="todos">Todos os Municípios</option>'; // Reset com opção padrão
            
            if (metadados.municipios_disponiveis && metadados.municipios_disponiveis.length > 0) {
                // Ordenar municípios em ordem alfabética
                const municipiosOrdenados = [...metadados.municipios_disponiveis].sort();
                
                // Adicionar opções para cada município
                municipiosOrdenados.forEach(municipio => {
                    const option = document.createElement('option');
                    option.value = municipio;
                    option.textContent = municipio;
                    selectMunicipio.appendChild(option);
                });
            }
            
            // Configurar checkboxes de regiões
            const checkboxesRegioes = document.getElementById('checkboxesRegioes');
            checkboxesRegioes.innerHTML = ''; // Limpar conteúdo existente
            
            if (metadados.regioes_disponiveis && metadados.regioes_disponiveis.length > 0) {
                // Ordenar regiões
                const regioesOrdenadas = [...metadados.regioes_disponiveis].sort();
                
                // Adicionar checkbox para cada região
                regioesOrdenadas.forEach(regiao => {
                    const divCheck = document.createElement('div');
                    divCheck.className = 'form-check';
                    
                    const input = document.createElement('input');
                    input.className = 'form-check-input checkbox-regiao';
                    input.type = 'checkbox';
                    input.id = `check-${regiao.replace(/\s+/g, '-').toLowerCase()}`;
                    input.value = regiao;
                    // Selecionar Brasil e Maranhão por padrão se existirem
                    input.checked = (regiao === 'Brasil' || regiao === 'Maranhão');
                    
                    const label = document.createElement('label');
                    label.className = 'form-check-label';
                    label.htmlFor = input.id;
                    label.textContent = regiao;
                    
                    divCheck.appendChild(input);
                    divCheck.appendChild(label);
                    checkboxesRegioes.appendChild(divCheck);
                });
            }
            
            // Configurar evento de mudança para checkboxes de regiões
            document.querySelectorAll('.checkbox-regiao').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    // Atualizar array de regiões selecionadas
                    regioesSelecionadas = Array.from(document.querySelectorAll('.checkbox-regiao:checked')).map(cb => cb.value);
                    
                    // Atualizar gráficos relacionados
                    atualizarGraficoEvolucaoHistorica();
                });
            });
            
            // Configurar eventos para elementos da interface
            configurarEventos();
            
            // Atualizar visualizações com dados carregados
            atualizarVisualizacoes();
        }

        // Função para configurar eventos dos elementos da interface
        function configurarEventos() {
            // Evento para mudança de ano
            document.getElementById('selectAno').addEventListener('change', function() {
                anoSelecionado = this.value;
                atualizarVisualizacoes();
            });
            
            // Evento para mudança de município
            document.getElementById('selectMunicipio').addEventListener('change', function() {
                municipioSelecionado = this.value;
                
                // Mostrar/ocultar conteúdo com base na seleção
                if (municipioSelecionado === 'todos') {
                    document.getElementById('todosMunicipios').style.display = 'block';
                    document.getElementById('municipioDetalhado').style.display = 'none';
                } else {
                    document.getElementById('todosMunicipios').style.display = 'none';
                    document.getElementById('municipioDetalhado').style.display = 'block';
                    
                    // Atualizar título do gráfico de evolução
                    document.getElementById('chartEvolucaoMunicipioTitle').innerHTML = 
                        `<i class="fas fa-chart-line me-2"></i>Evolução da Taxa de Subregistro em ${municipioSelecionado}`;
                }
                
                // Atualizar visualizações
                atualizarVisualizacoes();
            });
            
            // Evento para unidades interligadas
            document.getElementById('checkUnidadesInterligadas').addEventListener('change', function() {
                document.getElementById('unidadesInterligadasContent').style.display = this.checked ? 'block' : 'none';
            });
            
            // Evento para informações COGEX
            document.getElementById('checkInfoCogex').addEventListener('change', function() {
                document.getElementById('infoCoGEXContent').style.display = this.checked ? 'block' : 'none';
            });
            
            // Evento para resetar filtros
            document.getElementById('btnResetFilters').addEventListener('click', function() {
                // Resetar ano para o mais recente
                const selectAno = document.getElementById('selectAno');
                selectAno.selectedIndex = 0;
                anoSelecionado = selectAno.value;
                
                // Resetar município para "todos"
                document.getElementById('selectMunicipio').value = 'todos';
                municipioSelecionado = 'todos';
                
                // Mostrar conteúdo de "todos os municípios"
                document.getElementById('todosMunicipios').style.display = 'block';
                document.getElementById('municipioDetalhado').style.display = 'none';
                
                // Resetar checkboxes de regiões (selecionar apenas Brasil e Maranhão)
                document.querySelectorAll('.checkbox-regiao').forEach(checkbox => {
                    checkbox.checked = (checkbox.value === 'Brasil' || checkbox.value === 'Maranhão');
                });
                
                // Atualizar array de regiões selecionadas
                regioesSelecionadas = Array.from(document.querySelectorAll('.checkbox-regiao:checked')).map(cb => cb.value);
                
                // Resetar outros checkboxes
                document.getElementById('checkUnidadesInterligadas').checked = true;
                document.getElementById('checkInfoCogex').checked = true;
                
                // Mostrar conteúdos relacionados
                document.getElementById('unidadesInterligadasContent').style.display = 'block';
                document.getElementById('infoCoGEXContent').style.display = 'block';
                
                // Atualizar visualizações
                atualizarVisualizacoes();
            });
            
            // Evento para exportar tabela
            document.getElementById('btnExportTable').addEventListener('click', exportarTabelaCSV);
            
            // Eventos para ordenação da tabela
            document.querySelectorAll('.sort-table').forEach(button => {
                button.addEventListener('click', function() {
                    const sortField = this.getAttribute('data-sort');
                    const sortOrder = this.getAttribute('data-order');
                    
                    // Ordenar e atualizar tabela
                    atualizarTabelaMunicipios(sortField, sortOrder);
                });
            });
            
            // Eventos para download de gráficos
            document.querySelectorAll('.download-chart').forEach(button => {
                button.addEventListener('click', function() {
                    const chartId = this.getAttribute('data-chart');
                    exportarGrafico(chartId);
                });
            });
            
            // Evento para exportar dados completos
            document.getElementById('btnExportData').addEventListener('click', exportarDadosCompletos);
        }

        // Função para atualizar todas as visualizações
        function atualizarVisualizacoes() {
            // Atualizar métricas principais
            atualizarMetricas();
            
            // Atualizar gráficos do panorama geral
            atualizarGraficoTaxaRegiao();
            atualizarGraficoTaxaMunicipio();
            
            // Atualizar visualizações de município
            if (municipioSelecionado === 'todos') {
                atualizarTabelaMunicipios();
                atualizarGraficoTop5Municipios();
            } else {
                atualizarMetricasMunicipio();
                atualizarGraficoEvolucaoMunicipio();
                atualizarGraficoComparativoEstadual();
            }
            
            // Atualizar séries históricas
            atualizarGraficoEvolucaoHistorica();
        }

        // Função para atualizar métricas principais
        function atualizarMetricas() {
            try {
                // Filtrar dados do Maranhão para o ano selecionado
                const dadosMAAtual = dadosRegioes.find(r => r.Região === 'Maranhão' && r.Ano == anoSelecionado);
                const dadosBRAtual = dadosRegioes.find(r => r.Região === 'Brasil' && r.Ano == anoSelecionado);
                
                // Encontrar dados do ano anterior para comparação
                const anoAnterior = parseInt(anoSelecionado) - 1;
                const dadosMAAnterior = dadosRegioes.find(r => r.Região === 'Maranhão' && r.Ano == anoAnterior);
                
                if (dadosMAAtual) {
                    // Atualizar taxa de subregistro
                    document.getElementById('metricTaxaSubregistro').textContent = formatarPercentual(dadosMAAtual.Taxa_Subregistro);
                    
                    // Calcular diferença com Brasil
                    if (dadosBRAtual) {
                        const diff = dadosMAAtual.Taxa_Subregistro - dadosBRAtual.Taxa_Subregistro;
                        const diffText = (diff >= 0 ? '+' : '') + formatarPercentual(diff);
                        document.getElementById('metricTaxaSubregistroChange').innerHTML = 
                            `<i class="fas fa-arrow-${diff >= 0 ? 'up' : 'down'} me-1"></i>${diffText} vs Brasil`;
                        
                        // Ajustar classe para cor
                        document.getElementById('metricTaxaSubregistroChange').className = 
                            `metric-change ${diff >= 0 ? 'negative' : 'positive'}`;
                    }
                    
                    // Atualizar nascidos vivos
                    document.getElementById('metricNascidosVivos').textContent = formatarNumero(dadosMAAtual.Nascidos_Vivos);
                    
                    // Calcular variação em relação ao ano anterior
                    if (dadosMAAnterior) {
                        const diffNascidos = ((dadosMAAtual.Nascidos_Vivos / dadosMAAnterior.Nascidos_Vivos) - 1) * 100;
                        const diffNascidosText = (diffNascidos >= 0 ? '+' : '') + formatarPercentual(diffNascidos);
                        document.getElementById('metricNascidosVivosChange').innerHTML = 
                            `<i class="fas fa-arrow-${diffNascidos >= 0 ? 'up' : 'down'} me-1"></i>${diffNascidosText} vs ${anoAnterior}`;
                        
                        // Ajustar classe para cor
                        document.getElementById('metricNascidosVivosChange').className = 
                            `metric-change ${diffNascidos >= 0 ? 'positive' : 'negative'}`;
                    }
                    
                    // Atualizar registros civis
                    document.getElementById('metricRegistrosCivis').textContent = formatarNumero(dadosMAAtual.Registros_Civil);
                    
                    // Calcular variação em relação ao ano anterior
                    if (dadosMAAnterior) {
                        const diffRegistros = ((dadosMAAtual.Registros_Civil / dadosMAAnterior.Registros_Civil) - 1) * 100;
                        const diffRegistrosText = (diffRegistros >= 0 ? '+' : '') + formatarPercentual(diffRegistros);
                        document.getElementById('metricRegistrosCivisChange').innerHTML = 
                            `<i class="fas fa-arrow-${diffRegistros >= 0 ? 'up' : 'down'} me-1"></i>${diffRegistrosText} vs ${anoAnterior}`;
                        
                        // Ajustar classe para cor
                        document.getElementById('metricRegistrosCivisChange').className = 
                            `metric-change ${diffRegistros >= 0 ? 'positive' : 'negative'}`;
                    }
                }
            } catch (erro) {
                console.error('Erro ao atualizar métricas:', erro);
            }
        }

        // Função para atualizar métricas do município selecionado
        function atualizarMetricasMunicipio() {
            try {
                if (municipioSelecionado === 'todos') return;
                
                // Filtrar dados do município para o ano selecionado
                const dadosMunicipioAtual = dadosMunicipios.find(m => 
                    m.Município === municipioSelecionado && m.Ano == anoSelecionado);
                
                // Encontrar dados do ano anterior para comparação
                const anoAnterior = parseInt(anoSelecionado) - 1;
                const dadosMunicipioAnterior = dadosMunicipios.find(m => 
                    m.Município === municipioSelecionado && m.Ano == anoAnterior);
                
                if (dadosMunicipioAtual) {
                    // Atualizar taxa de subregistro
                    document.getElementById('metricMunicipioTaxa').textContent = formatarPercentual(dadosMunicipioAtual.Taxa_Subregistro);
                    
                    // Calcular variação em relação ao ano anterior
                    if (dadosMunicipioAnterior) {
                        const diffTaxa = dadosMunicipioAtual.Taxa_Subregistro - dadosMunicipioAnterior.Taxa_Subregistro;
                        const diffTaxaText = (diffTaxa >= 0 ? '+' : '') + formatarPercentual(diffTaxa);
                        document.getElementById('metricMunicipioTaxaChange').innerHTML = 
                            `<i class="fas fa-arrow-${diffTaxa >= 0 ? 'up' : 'down'} me-1"></i>${diffTaxaText} vs ${anoAnterior}`;
                        
                        // Ajustar classe para cor (menor taxa é melhor, então lógica inversa)
                        document.getElementById('metricMunicipioTaxaChange').className = 
                            `metric-change ${diffTaxa >= 0 ? 'negative' : 'positive'}`;
                    }
                    
                    // Atualizar nascidos vivos
                    document.getElementById('metricMunicipioNascidos').textContent = formatarNumero(dadosMunicipioAtual.Nascidos_Vivos);
                    
                    // Calcular variação em relação ao ano anterior
                    if (dadosMunicipioAnterior) {
                        const diffNascidos = ((dadosMunicipioAtual.Nascidos_Vivos / dadosMunicipioAnterior.Nascidos_Vivos) - 1) * 100;
                        const diffNascidosText = (diffNascidos >= 0 ? '+' : '') + formatarPercentual(diffNascidos);
                        document.getElementById('metricMunicipioNascidosChange').innerHTML = 
                            `<i class="fas fa-arrow-${diffNascidos >= 0 ? 'up' : 'down'} me-1"></i>${diffNascidosText} vs ${anoAnterior}`;
                        
                        // Ajustar classe para cor
                        document.getElementById('metricMunicipioNascidosChange').className = 
                            `metric-change ${diffNascidos >= 0 ? 'positive' : 'negative'}`;
                    }
                    
                    // Atualizar registros civis
                    document.getElementById('metricMunicipioRegistros').textContent = formatarNumero(dadosMunicipioAtual.Registros_Civil);
                    
                    // Calcular variação em relação ao ano anterior
                    if (dadosMunicipioAnterior) {
                        const diffRegistros = ((dadosMunicipioAtual.Registros_Civil / dadosMunicipioAnterior.Registros_Civil) - 1) * 100;
                        const diffRegistrosText = (diffRegistros >= 0 ? '+' : '') + formatarPercentual(diffRegistros);
                        document.getElementById('metricMunicipioRegistrosChange').innerHTML = 
                            `<i class="fas fa-arrow-${diffRegistros >= 0 ? 'up' : 'down'} me-1"></i>${diffRegistrosText} vs ${anoAnterior}`;
                        
                        // Ajustar classe para cor
                        document.getElementById('metricMunicipioRegistrosChange').className = 
                            `metric-change ${diffRegistros >= 0 ? 'positive' : 'negative'}`;
                    }
                }
            } catch (erro) {
                console.error('Erro ao atualizar métricas do município:', erro);
            }
        }

        // Função para atualizar o gráfico de taxa por região
        function atualizarGraficoTaxaRegiao() {
            try {
                const chartContainer = document.getElementById('chartTaxaRegiao');
                const loadingContainer = chartContainer.querySelector('.loading-container');
                
                // Mostrar loader
                if (loadingContainer) loadingContainer.style.display = 'flex';
                
                // Filtrar dados para o ano selecionado
                const dadosFiltrados = dadosRegioes.filter(r => r.Ano == anoSelecionado);
                
                // Ordenar por taxa de subregistro (decrescente)
                const dadosOrdenados = [...dadosFiltrados].sort((a, b) => b.Taxa_Subregistro - a.Taxa_Subregistro);
                
                // Preparar dados para o gráfico
                const regioes = dadosOrdenados.map(r => r.Região);
                const taxas = dadosOrdenados.map(r => r.Taxa_Subregistro);
                
                // Cores baseadas na taxa (vermelho mais intenso para valores maiores)
                const cores = taxas.map(taxa => {
                    const intensidade = Math.min(255, Math.round(50 + (taxa / 10) * 205));
                    return `rgba(${intensidade}, 50, 50, 0.8)`;
                });
                
                // Configurar dados do gráfico
                const data = [{
                    x: regioes,
                    y: taxas,
                    type: 'bar',
                    marker: {
                        color: cores
                    },
                    text: taxas.map(t => t.toFixed(1) + '%'),
                    textposition: 'auto',
                    hoverinfo: 'x+y',
                    hovertemplate: '%{y:.1f}%<extra>%{x}</extra>'
                }];
                
                // Layout do gráfico
                const layout = {
                    title: `Taxa de Subregistro por Região - ${anoSelecionado}`,
                    xaxis: {
                        title: '',
                        tickangle: -45
                    },
                    yaxis: {
                        title: 'Taxa de Subregistro (%)',
                        tickformat: '.1f'
                    },
                    margin: {
                        l: 50,
                        r: 20,
                        t: 50,
                        b: 100
                    },
                    autosize: true,
                    height: 400
                };
                
                // Opções de configuração
                const config = {
                    responsive: true,
                    displayModeBar: false
                };
                
                // Criar gráfico
                Plotly.newPlot(chartContainer, data, layout, config);
                
                // Ocultar loader após o carregamento
                if (loadingContainer) loadingContainer.style.display = 'none';
                
            } catch (erro) {
                console.error('Erro ao atualizar gráfico de taxa por região:', erro);
                
                // Ocultar loader em caso de erro
                const loadingContainer = document.querySelector('#chartTaxaRegiao .loading-container');
                if (loadingContainer) loadingContainer.style.display = 'none';
            }
        }

        // Função para atualizar o gráfico de taxa por município
        function atualizarGraficoTaxaMunicipio() {
            try {
                const chartContainer = document.getElementById('chartTaxaMunicipio');
                const loadingContainer = chartContainer.querySelector('.loading-container');
                
                // Mostrar loader
                if (loadingContainer) loadingContainer.style.display = 'flex';
                
                // Filtrar dados para o ano selecionado
                const dadosFiltrados = dadosMunicipios.filter(m => m.Ano == anoSelecionado);
                
                // Ordenar por taxa de subregistro (decrescente)
                const dadosOrdenados = [...dadosFiltrados].sort((a, b) => b.Taxa_Subregistro - a.Taxa_Subregistro);
                
                // Limitar a exibição aos 15 primeiros municípios (para não sobrecarregar o gráfico)
                const dadosLimitados = dadosOrdenados.slice(0, 15);
                
                // Preparar dados para o gráfico
                const municipios = dadosLimitados.map(m => m.Município);
                const taxas = dadosLimitados.map(m => m.Taxa_Subregistro);
                
                // Cores baseadas na taxa (vermelho mais intenso para valores maiores)
                const cores = taxas.map(taxa => {
                    const intensidade = Math.min(255, Math.round(50 + (taxa / 10) * 205));
                    return `rgba(${intensidade}, 50, 50, 0.8)`;
                });
                
                // Configurar dados do gráfico
                const data = [{
                    x: municipios,
                    y: taxas,
                    type: 'bar',
                    marker: {
                        color: cores
                    },
                    text: taxas.map(t => t.toFixed(1) + '%'),
                    textposition: 'auto',
                    hoverinfo: 'x+y',
                    hovertemplate: '%{y:.1f}%<extra>%{x}</extra>'
                }];
                
                // Layout do gráfico
                const layout = {
                    title: `Municípios com Maior Taxa de Subregistro - ${anoSelecionado}`,
                    xaxis: {
                        title: '',
                        tickangle: -45
                    },
                    yaxis: {
                        title: 'Taxa de Subregistro (%)',
                        tickformat: '.1f'
                    },
                    margin: {
                        l: 50,
                        r: 20,
                        t: 50,
                        b: 120
                    },
                    autosize: true,
                    height: 400
                };
                
                // Opções de configuração
                const config = {
                    responsive: true,
                    displayModeBar: false
                };
                
                // Criar gráfico
                Plotly.newPlot(chartContainer, data, layout, config);
                
                // Ocultar loader após o carregamento
                if (loadingContainer) loadingContainer.style.display = 'none';
                
            } catch (erro) {
                console.error('Erro ao atualizar gráfico de taxa por município:', erro);
                
                // Ocultar loader em caso de erro
                const loadingContainer = document.querySelector('#chartTaxaMunicipio .loading-container');
                if (loadingContainer) loadingContainer.style.display = 'none';
            }
        }

        // Função para atualizar a tabela de municípios
        function atualizarTabelaMunicipios(sortField = 'taxa', sortOrder = 'desc') {
            try {
                // Filtrar dados para o ano selecionado
                const dadosFiltrados = dadosMunicipios.filter(m => m.Ano == anoSelecionado);
                
                // Ordenar dados conforme especificado
                let dadosOrdenados;
                
                switch (sortField) {
                    case 'municipio':
                        dadosOrdenados = [...dadosFiltrados].sort((a, b) => {
                            return sortOrder === 'asc' 
                                ? a.Município.localeCompare(b.Município) 
                                : b.Município.localeCompare(a.Município);
                        });
                        break;
                    case 'nascidos':
                        dadosOrdenados = [...dadosFiltrados].sort((a, b) => {
                            return sortOrder === 'asc' 
                                ? a.Nascidos_Vivos - b.Nascidos_Vivos 
                                : b.Nascidos_Vivos - a.Nascidos_Vivos;
                        });
                        break;
                    case 'taxa':
                    default:
                        dadosOrdenados = [...dadosFiltrados].sort((a, b) => {
                            return sortOrder === 'asc' 
                                ? a.Taxa_Subregistro - b.Taxa_Subregistro 
                                : b.Taxa_Subregistro - a.Taxa_Subregistro;
                        });
                }
                
                // Obter corpo da tabela
                const tbody = document.querySelector('#tableMunicipios tbody');
                
                // Limpar conteúdo existente
                tbody.innerHTML = '';
                
                // Adicionar linhas para cada município
                dadosOrdenados.forEach(municipio => {
                    const tr = document.createElement('tr');
                    
                    // Definir classe de status com base na taxa
                    let statusClass, statusText;
                    if (municipio.Taxa_Subregistro >= 7) {
                        statusClass = 'danger';
                        statusText = 'Alto';
                    } else if (municipio.Taxa_Subregistro >= 3) {
                        statusClass = 'warning';
                        statusText = 'Médio';
                    } else {
                        statusClass = 'success';
                        statusText = 'Baixo';
                    }
                    
                    // Conteúdo da linha
                    tr.innerHTML = `
                        <td>${municipio.Município}</td>
                        <td>${formatarNumero(municipio.Nascidos_Vivos)}</td>
                        <td>${formatarNumero(municipio.Registros_Civil)}</td>
                        <td>${formatarPercentual(municipio.Taxa_Subregistro)}</td>
                        <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                    `;
                    
                    tbody.appendChild(tr);
                });
                
            } catch (erro) {
                console.error('Erro ao atualizar tabela de municípios:', erro);
                
                // Exibir mensagem de erro na tabela
                const tbody = document.querySelector('#tableMunicipios tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-danger">
                            Erro ao carregar dados. Tente novamente.
                        </td>
                    </tr>
                `;
            }
        }

        // Função para atualizar o gráfico de top 5 municípios
        function atualizarGraficoTop5Municipios() {
            try {
                const chartContainer = document.getElementById('chartTop5Municipios');
                const loadingContainer = chartContainer.querySelector('.loading-container');
                
                // Mostrar loader
                if (loadingContainer) loadingContainer.style.display = 'flex';
                
                // Filtrar dados para o ano selecionado
                const dadosFiltrados = dadosMunicipios.filter(m => m.Ano == anoSelecionado);
                
                // Ordenar por taxa de subregistro (decrescente) e pegar os 5 primeiros
                const top5 = [...dadosFiltrados]
                    .sort((a, b) => b.Taxa_Subregistro - a.Taxa_Subregistro)
                    .slice(0, 5);
                
                // Preparar dados para o gráfico
                const municipios = top5.map(m => m.Município);
                const taxas = top5.map(m => m.Taxa_Subregistro);
                
                // Cores baseadas na taxa
                const cores = taxas.map(taxa => {
                    const intensidade = Math.min(255, Math.round(50 + (taxa / 10) * 205));
                    return `rgba(${intensidade}, 50, 50, 0.8)`;
                });
                
                // Configurar dados do gráfico
                const data = [{
                    x: municipios,
                    y: taxas,
                    type: 'bar',
                    marker: {
                        color: cores
                    },
                    text: taxas.map(t => t.toFixed(1) + '%'),
                    textposition: 'auto',
                    hoverinfo: 'x+y',
                    hovertemplate: '%{y:.1f}%<extra>%{x}</extra>'
                }];
                
                // Layout do gráfico
                const layout = {
                    title: `Top 5 Municípios com Maior Taxa de Subregistro - ${anoSelecionado}`,
                    xaxis: {
                        title: ''
                    },
                    yaxis: {
                        title: 'Taxa de Subregistro (%)',
                        tickformat: '.1f'
                    },
                    margin: {
                        l: 50,
                        r: 20,
                        t: 50,
                        b: 50
                    },
                    autosize: true,
                    height: 400
                };
                
                // Opções de configuração
                const config = {
                    responsive: true,
                    displayModeBar: false
                };
                
                // Criar gráfico
                Plotly.newPlot(chartContainer, data, layout, config);
                
                // Ocultar loader após o carregamento
                if (loadingContainer) loadingContainer.style.display = 'none';
                
            } catch (erro) {
                console.error('Erro ao atualizar gráfico de top 5 municípios:', erro);
                
                // Ocultar loader em caso de erro
                const loadingContainer = document.querySelector('#chartTop5Municipios .loading-container');
                if (loadingContainer) loadingContainer.style.display = 'none';
            }
        }

        // Função para atualizar o gráfico de evolução do município
        function atualizarGraficoEvolucaoMunicipio() {
            try {
                if (municipioSelecionado === 'todos') return;
                
                const chartContainer = document.getElementById('chartEvolucaoMunicipio');
                const loadingContainer = chartContainer.querySelector('.loading-container');
                
                // Mostrar loader
                if (loadingContainer) loadingContainer.style.display = 'flex';
                
                // Filtrar dados para o município selecionado
                const dadosMunicipio = dadosMunicipios.filter(m => m.Município === municipioSelecionado);
                
                // Ordenar por ano (crescente)
                const dadosOrdenados = [...dadosMunicipio].sort((a, b) => a.Ano - b.Ano);
                
                // Preparar dados para o gráfico
                const anos = dadosOrdenados.map(m => m.Ano);
                const taxas = dadosOrdenados.map(m => m.Taxa_Subregistro);
                
                // Configurar dados do gráfico
                const data = [{
                    x: anos,
                    y: taxas,
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: {
                        color: 'rgb(26, 35, 126)',
                        width: 3
                    },
                    marker: {
                        color: 'rgb(26, 35, 126)',
                        size: 8
                    },
                    text: taxas.map(t => t.toFixed(1) + '%'),
                    textposition: 'top center',
                    hoverinfo: 'x+y',
                    hovertemplate: '%{y:.1f}%<extra>%{x}</extra>'
                }];
                
                // Layout do gráfico
                const layout = {
                    title: `Evolução da Taxa de Subregistro em ${municipioSelecionado}`,
                    xaxis: {
                        title: 'Ano',
                        tickmode: 'array',
                        tickvals: anos,
                        ticktext: anos.map(a => a.toString())
                    },
                    yaxis: {
                        title: 'Taxa de Subregistro (%)',
                        tickformat: '.1f'
                    },
                    margin: {
                        l: 50,
                        r: 20,
                        t: 50,
                        b: 50
                    },
                    autosize: true,
                    height: 400
                };
                
                // Opções de configuração
                const config = {
                    responsive: true,
                    displayModeBar: false
                };
                
                // Criar gráfico
                Plotly.newPlot(chartContainer, data, layout, config);
                
                // Ocultar loader após o carregamento
                if (loadingContainer) loadingContainer.style.display = 'none';
                
            } catch (erro) {
                console.error('Erro ao atualizar gráfico de evolução do município:', erro);
                
                // Ocultar loader em caso de erro
                const loadingContainer = document.querySelector('#chartEvolucaoMunicipio .loading-container');
                if (loadingContainer) loadingContainer.style.display = 'none';
            }
        }

        // Função para atualizar o gráfico de comparação com média estadual
        function atualizarGraficoComparativoEstadual() {
            try {
                if (municipioSelecionado === 'todos') return;
                
                const chartContainer = document.getElementById('chartComparativoEstadual');
                const loadingContainer = chartContainer.querySelector('.loading-container');
                
                // Mostrar loader
                if (loadingContainer) loadingContainer.style.display = 'flex';
                
                // Filtrar dados para o município selecionado
                const dadosMunicipio = dadosMunicipios.filter(m => m.Município === municipioSelecionado);
                
                // Filtrar dados do Maranhão
                const dadosMaranhao = dadosRegioes.filter(r => r.Região === 'Maranhão');
                
                // Encontrar anos comuns para comparação válida
                const anosMunicipio = dadosMunicipio.map(m => m.Ano);
                const anosMaranhao = dadosMaranhao.map(r => r.Ano);
                const anosComuns = anosMunicipio.filter(ano => anosMaranhao.includes(ano));
                
                // Filtrar apenas anos comuns
                const dadosMunicipioFiltrados = dadosMunicipio.filter(m => anosComuns.includes(m.Ano));
                const dadosMaranhaoFiltrados = dadosMaranhao.filter(r => anosComuns.includes(r.Ano));
                
                // Ordenar por ano (crescente)
                const dadosMunicipioOrdenados = [...dadosMunicipioFiltrados].sort((a, b) => a.Ano - b.Ano);
                const dadosMaranhaoOrdenados = [...dadosMaranhaoFiltrados].sort((a, b) => a.Ano - b.Ano);
                
                // Preparar dados para o gráfico
                const anos = dadosMunicipioOrdenados.map(m => m.Ano);
                const taxasMunicipio = dadosMunicipioOrdenados.map(m => m.Taxa_Subregistro);
                const taxasMaranhao = dadosMaranhaoOrdenados.map(r => r.Taxa_Subregistro);
                
                // Configurar dados do gráfico
                const data = [
                    {
                        x: anos,
                        y: taxasMunicipio,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: municipioSelecionado,
                        line: {
                            color: 'rgb(26, 35, 126)',
                            width: 3
                        },
                        marker: {
                            color: 'rgb(26, 35, 126)',
                            size: 8
                        },
                        hovertemplate: '%{y:.1f}%<extra>%{x}</extra>'
                    },
                    {
                        x: anos,
                        y: taxasMaranhao,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Média do Maranhão',
                        line: {
                            color: 'rgb(211, 47, 47)',
                            width: 3,
                            dash: 'dash'
                        },
                        marker: {
                            color: 'rgb(211, 47, 47)',
                            size: 8
                        },
                        hovertemplate: '%{y:.1f}%<extra>%{x}</extra>'
                    }
                ];
                
                // Layout do gráfico
                const layout = {
                    title: `Comparação entre ${municipioSelecionado} e Média Estadual`,
                    xaxis: {
                        title: 'Ano',
                        tickmode: 'array',
                        tickvals: anos,
                        ticktext: anos.map(a => a.toString())
                    },
                    yaxis: {
                        title: 'Taxa de Subregistro (%)',
                        tickformat: '.1f'
                    },
                    legend: {
                        orientation: 'h',
                        yanchor: 'bottom',
                        y: 1.02,
                        xanchor: 'right',
                        x: 1
                    },
                    margin: {
                        l: 50,
                        r: 20,
                        t: 50,
                        b: 50
                    },
                    autosize: true,
                    height: 400
                };
                
                // Opções de configuração
                const config = {
                    responsive: true,
                    displayModeBar: false
                };
                
                // Criar gráfico
                Plotly.newPlot(chartContainer, data, layout, config);
                
                // Ocultar loader após o carregamento
                if (loadingContainer) loadingContainer.style.display = 'none';
                
            } catch (erro) {
                console.error('Erro ao atualizar gráfico comparativo estadual:', erro);
                
                // Ocultar loader em caso de erro
                const loadingContainer = document.querySelector('#chartComparativoEstadual .loading-container');
                if (loadingContainer) loadingContainer.style.display = 'none';
            }
        }

        // Função para atualizar o gráfico de evolução histórica
        function atualizarGraficoEvolucaoHistorica() {
            try {
                const chartContainer = document.getElementById('chartEvolucaoHistorica');
                const loadingContainer = chartContainer.querySelector('.loading-container');
                
                // Mostrar loader
                if (loadingContainer) loadingContainer.style.display = 'flex';
                
                // Verificar se há regiões selecionadas
                if (!regioesSelecionadas || regioesSelecionadas.length === 0) {
                    // Se não houver, usar Brasil e Maranhão se disponíveis
                    const regioes = [...new Set(dadosRegioes.map(r => r.Região))];
                    
                    if (regioes.includes('Brasil') && regioes.includes('Maranhão')) {
                        regioesSelecionadas = ['Brasil', 'Maranhão'];
                    } else if (regioes.length > 0) {
                        // Se não houver Brasil e Maranhão, usar as duas primeiras regiões
                        regioesSelecionadas = regioes.slice(0, 2);
                    }
                }
                
                // Filtrar dados para as regiões selecionadas
                const dadosFiltrados = dadosRegioes.filter(r => regioesSelecionadas.includes(r.Região));
                
                // Obter anos únicos
                const anosUnicos = [...new Set(dadosFiltrados.map(r => r.Ano))].sort();
                
                // Criar traces para cada região
                const traces = [];
                const cores = {
                    'Brasil': 'rgb(26, 35, 126)',
                    'Maranhão': 'rgb(211, 47, 47)',
                    'Nordeste': 'rgb(56, 142, 60)',
                    'Norte': 'rgb(245, 124, 0)',
                    'Sudeste': 'rgb(2, 136, 209)',
                    'Sul': 'rgb(156, 39, 176)',
                    'Centro-Oeste': 'rgb(120, 144, 156)'
                };
                
                // Criar um trace para cada região selecionada
                for (const regiao of regioesSelecionadas) {
                    // Filtrar dados da região
                    const dadosRegiao = dadosFiltrados.filter(r => r.Região === regiao);
                    
                    // Ordenar por ano
                    const dadosOrdenados = [...dadosRegiao].sort((a, b) => a.Ano - b.Ano);
                    
                    // Preparar dados para o trace
                    const anos = dadosOrdenados.map(r => r.Ano);
                    const taxas = dadosOrdenados.map(r => r.Taxa_Subregistro);
                    
                    // Criar trace
                    traces.push({
                        x: anos,
                        y: taxas,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: regiao,
                        line: {
                            color: cores[regiao] || '#000000',
                            width: 3
                        },
                        marker: {
                            color: cores[regiao] || '#000000',
                            size: 8
                        },
                        hovertemplate: '%{y:.1f}%<extra>%{x}</extra>'
                    });
                }
                
                // Layout do gráfico
                const layout = {
                    title: 'Evolução Histórica da Taxa de Subregistro',
                    xaxis: {
                        title: 'Ano',
                        tickmode: 'array',
                        tickvals: anosUnicos,
                        ticktext: anosUnicos.map(a => a.toString())
                    },
                    yaxis: {
                        title: 'Taxa de Subregistro (%)',
                        tickformat: '.1f'
                    },
                    legend: {
                        orientation: 'h',
                        yanchor: 'bottom',
                        y: 1.02,
                        xanchor: 'right',
                        x: 1
                    },
                    margin: {
                        l: 50,
                        r: 20,
                        t: 50,
                        b: 50
                    },
                    autosize: true,
                    height: 400
                };
                
                // Opções de configuração
                const config = {
                    responsive: true,
                    displayModeBar: false
                };
                
                // Criar gráfico
                Plotly.newPlot(chartContainer, traces, layout, config);
                
                // Ocultar loader após o carregamento
                if (loadingContainer) loadingContainer.style.display = 'none';
                
            } catch (erro) {
                console.error('Erro ao atualizar gráfico de evolução histórica:', erro);
                
                // Ocultar loader em caso de erro
                const loadingContainer = document.querySelector('#chartEvolucaoHistorica .loading-container');
                if (loadingContainer) loadingContainer.style.display = 'none';
            }
        }

        // Função para exportar a tabela de municípios como CSV
        function exportarTabelaCSV() {
            try {
                // Filtrar dados para o ano selecionado
                const dadosFiltrados = dadosMunicipios.filter(m => m.Ano == anoSelecionado);
                
                // Ordenar por taxa de subregistro (decrescente)
                const dadosOrdenados = [...dadosFiltrados].sort((a, b) => b.Taxa_Subregistro - a.Taxa_Subregistro);
                
                // Criar cabeçalho do CSV
                let csv = 'Município,Nascidos_Vivos,Registros_Civil,Taxa_Subregistro\n';
                
                // Adicionar linhas para cada município
                dadosOrdenados.forEach(municipio => {
                    csv += `"${municipio.Município}",${municipio.Nascidos_Vivos},${municipio.Registros_Civil},${municipio.Taxa_Subregistro.toFixed(1)}\n`;
                });
                
                // Criar blob e link para download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `municipios_subregistro_${anoSelecionado}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (erro) {
                console.error('Erro ao exportar tabela como CSV:', erro);
                alert('Erro ao exportar dados. Tente novamente.');
            }
        }

        // Função para exportar gráfico como imagem
        function exportarGrafico(chartId) {
            try {
                const chartContainer = document.getElementById(chartId);
                
                // Usar a API do Plotly para exportar
                Plotly.downloadImage(chartContainer, {
                    format: 'png',
                    filename: `grafico_${chartId}_${anoSelecionado}`,
                    height: 600,
                    width: 800
                });
                
            } catch (erro) {
                console.error('Erro ao exportar gráfico:', erro);
                alert('Erro ao exportar gráfico. Tente novamente.');
            }
        }

        // Função para exportar dados completos
        function exportarDadosCompletos() {
            try {
                // Criar zip com todos os dados
                let zip = new JSZip();
                
                // Adicionar dados de municípios
                let csvMunicipios = 'Município,Ano,Nascidos_Vivos,Registros_Civil,Taxa_Subregistro\n';
                dadosMunicipios.forEach(municipio => {
                    csvMunicipios += `"${municipio.Município}",${municipio.Ano},${municipio.Nascidos_Vivos},${municipio.Registros_Civil},${municipio.Taxa_Subregistro.toFixed(1)}\n`;
                });
                zip.file("municipios.csv", csvMunicipios);
                
                // Adicionar dados de regiões
                let csvRegioes = 'Região,Ano,Nascidos_Vivos,Registros_Civil,Taxa_Subregistro\n';
                dadosRegioes.forEach(regiao => {
                    csvRegioes += `"${regiao.Região}",${regiao.Ano},${regiao.Nascidos_Vivos},${regiao.Registros_Civil},${regiao.Taxa_Subregistro.toFixed(1)}\n`;
                });
                zip.file("regioes.csv", csvRegioes);
                
                // Adicionar metadados
                zip.file("metadados.json", JSON.stringify(metadados, null, 2));
                
                // Gerar e baixar o arquivo zip
                zip.generateAsync({type:"blob"}).then(function(content) {
                    const url = URL.createObjectURL(content);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', `dados_subregistro_completos.zip`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
                
            } catch (erro) {
                console.error('Erro ao exportar dados completos:', erro);
                alert('Erro ao exportar dados completos. Tente novamente.');
            }
        }

        // Carregar dados ao iniciar a página
        document.addEventListener('DOMContentLoaded', carregarDados);
    </script>
</body>
</html>
